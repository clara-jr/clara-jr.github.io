---
layout: ../../layouts/PostLayout.astro
title: 'Mover la l√≥gica de una Alexa-Hosted Skill a una funci√≥n Lambda en AWS üë©üèª‚Äçüíª'
pubDate: 2020/05/06
description: 'Las Alexa-Hosted Skills nos permiten desarrollar una Skill de Alexa end-to-end haciendo uso de la capa gratuita de AWS pero, ¬øy si necesitamos m√°s?'
author: 'Clara Jim√©nez'
image:
    url: 'https://s3-eu-west-1.amazonaws.com/blog-cjr-assets/lambda3.png' 
    alt: 'Alexa Skill Lambda'
tags: ["aws", "alexa"]
---
Lo m√°s sencillo y directo a la hora de crear una Skill de Alexa es hacerlo todo a trav√©s de la consola de desarrollo de Alexa, donde describiremos siempre el Voice Interaction Model o Modelo de Interacci√≥n Vocal, y adem√°s, podemos describir tambi√©n la l√≥gica de la Skill. Esto es lo que llamamos una Alexa-Hosted Skill. Servicios alojados en AWS son ofrecidos por Amazon, como una funci√≥n Lambda para la implementaci√≥n de la l√≥gica de nuestra Skill o espacio en Amazon S3 para almacenamiento de atributos persistentes. Desarrollar una Skill de este modo es totalmente gratuito para el desarrollador; sin embargo, tan s√≥lo incluye los servicios limitados por la capa gratuita de AWS. Estos servicios son:

Lambda Function: 1 mill√≥n de peticiones a la funci√≥n Lambda y 400 mil segundos de procesamiento al mes.

Amazon S3: 5 GB de almacenamiento en S3, 20 mil solicitudes de lectura al mes, 2 mil solicitudes de escritura al mes y 15 GB/mes de transferencia de datos.

AWS CodeCommit: 50 GB/mes de almacenamiento de versiones de c√≥digo y 10 mil solicitudes Git al mes.

Generalmente, estos limites pueden ser suficientes para el desarrollo de una Skill y su mantenimiento pero, en caso de no serlo, deber√≠amos cambiar el backend de nuestra Skill, la l√≥gica, a una funci√≥n Lambda propia de nuestra cuenta particular de AWS. Si nos pasamos de los l√≠mites ofrecidos por la capa gratuita de AWS, esto supondr√° un coste a cargo de nuestra cuenta. Sin embargo, Amazon promueve un gran n√∫mero de sistemas de recompensas y podemos registrarnos para llegar a obtener, por ejemplo, 100 $ de cr√©dito para AWS al mes.

¬øC√≥mo trasladar el c√≥digo de la consola de desarrollo de Alexa a la funci√≥n Lambda en AWS?
------------------------------------------------------------------------------------------

A medida que los desarrolladores de Amazon avanzan en este terreno de actualidad que son las Alexa Skills, se descubren necesidades y actualizaciones que nos permiten avanzar en la creaci√≥n m√°s r√°pida y enriquecedora de Alexa Skills.

Una de las herramientas a√±adidas en √∫ltimas actualizaciones fue la posibilidad de descargar el c√≥digo de la l√≥gica de una Alexa-Hosted Skill de la consola de desarrollo e insertarlo cargando un fichero comprimido en la funci√≥n Lambda de nuestra cuenta de AWS.

El primero de los pasos intermedios que habr√≠a que realizar en este traspaso de c√≥digo ser√≠a instalar en local las dependencias necesarias propias de nuestra Skill. En una Skill desarrollada en Node.js, nos referimos a los paquetes de la carpeta node\_modules indicados en nuestro fichero package.json que har√°n funcionar nuestra Skill. Para ello necesitaremos tener instalado npm, el sistema de gesti√≥n de paquetes por defecto para Node.js. Una vez instalado, ejecutamos el comando para la instalaci√≥n de dependencias:

```bash
npm install
```

El siguiente paso ser√≠a introducir la verificaci√≥n del ID de nuestra Skill en el c√≥digo de la misma, a trav√©s del m√©todo SkillBuilder.withSkillId en la configuraci√≥n de la instancia de nuestra Skill. De este modo, el c√≥digo de la Skill rechazar√° cualquier solicitud no proveniente de una Skill cuyo ID sea equivalente al representado en este m√©todo como par√°metro.

```javascript
Alexa.SkillBuilders.custom().withSkillId([ID])
```

El ID de nuestra Skill se muestra en la consola de desarrollo de Alexa, tanto en el listado de Skills como en la secci√≥n Build, en el apartado Endpoint.

![Alexa Skill Lambda](https://s3-eu-west-1.amazonaws.com/blog-cjr-assets/lambda1.png)

Ahora ya podemos volver a crear nuestro fichero comprimido incluyendo estas dependencias, es decir, la carpeta node\_modules trabajando con Node.js, y cargarla en nuestra funci√≥n Lambda previamente creada en AWS. Esta funci√≥n Lambda puede haber sido creada perfectamente como una funci√≥n ‚ÄúDesde Cero‚Äù.

![Alexa Skill Lambda](https://s3-eu-west-1.amazonaws.com/blog-cjr-assets/lambda2.png)

Una vez creada la funci√≥n Lambda y habiendo desplegado en ella el c√≥digo de la l√≥gica de nuestra Skill, es momento de terminar de conectar nuestra lambda con el Modelo de Interacci√≥n Vocal de nuestra Skill en la consola de desarrollo de Alexa. Para esto, debemos a√±adir un desencadenador o trigger del tipo Alexa Skills Kit a nuestra Lambda e introducir en √©l el ID de nuestra Skill.

![Alexa Skill Lambda](https://s3-eu-west-1.amazonaws.com/blog-cjr-assets/lambda3.png)

![Alexa Skill Lambda](https://s3-eu-west-1.amazonaws.com/blog-cjr-assets/lambda4.png)

Finalmente, debemos editar el endpoint de nuestra Skill en la secci√≥n Build de la consola de desarrollo, en el apartado Endpoint. Introducimos en este campo el Amazon Resource Name (ARN) de nuestra funci√≥n Lambda, que lo encontraremos en AWS, en la parte de arriba a la derecha de la p√°gina de configuraci√≥n de nuestra Lambda.

![Alexa Skill Lambda](https://s3-eu-west-1.amazonaws.com/blog-cjr-assets/lambda5.png)

Trabajar con versiones y alias para entornos de producci√≥n y desarrollo en AWS
------------------------------------------------------------------------------

Lo que he contado hasta ahora supondr√≠a la existencia de una √∫nica versi√≥n de nuestra funci√≥n Lambda tanto para producci√≥n como para desarrollo. Sin embargo, a lo largo de la vida √∫til de una Skill necesitaremos revisarla y hacer cambios que deberemos probar antes de publicarlos.

Para esto, necesitaremos tener un endpoint al que apunte nuestra Skill publicada y otro diferente para apuntar desde nuestra Skill en desarrollo. Sin embargo, ahora s√≥lo disponemos de un endpoint asociado al ARN por defecto (Incompleto o Unqualified), el cual est√° conectado con la versi√≥n $LATEST. Para disponer de varios endpoints tendremos que crear nuevos alias y asociar estos a distintas versiones. No nos olvidemos tampoco de configurar el trigger Alexa Skills Kit para cada uno de los alias que creemos.

![Alexa Skill Lambda Versions](https://s3-eu-west-1.amazonaws.com/blog-cjr-assets/lambda7.png)

![Alexa Skill Lambda Versions](https://s3-eu-west-1.amazonaws.com/blog-cjr-assets/lambda8.png)

El ARN del alias que utilicemos para publicar nuestra Skill deber√° apuntar a una versi√≥n estable y est√°tica, mientras que, podremos utilizar un segundo alias para nuestra Skill en desarrollo que, apuntando a una versi√≥n distinta, podamos editar y probar sin modificar la Skill publicada.

Empecemos por tanto creando un alias para la primera publicaci√≥n de nuestra Lambda, lo llamaremos ‚ÄúAlias 1‚Äù y quedar√° apuntando a la versi√≥n $LATEST. El endpoint al que vincularemos nuestra Skill en desarrollo ser√°, por tanto, el ARN del alias ‚ÄúAlias 1‚Äù. Ponemos a punto nuestra versi√≥n $LATEST y mandamos nuestra Skill al proceso de certificaci√≥n. Una vez publicada, estar√° vinculada al ‚ÄúAlias 1‚Äù, y no podr√° cambiarse esta vinculaci√≥n a no ser que pretendamos pasar otra vez el proceso de certificaci√≥n.

![Alexa Skill Lambda Alias](https://s3-eu-west-1.amazonaws.com/blog-cjr-assets/lambdaalias1.png)

Pues bien, podemos crear ahora una nueva versi√≥n a la que llamaremos ‚ÄúVersi√≥n 1‚Äù, con el mismo contenido que la versi√≥n $LATEST, y podemos tomar la decisi√≥n de editar el alias ‚ÄúAlias 1‚Äù para que apunte a esta versi√≥n, la cual ser√° una versi√≥n estable que a su vez debe ser est√°tica, no es modificable. Tendremos as√≠ el c√≥digo de nuestra Skill p√∫blica congelado en el alias ‚ÄúAlias 1‚Äù que lleva por versi√≥n ‚ÄúVersi√≥n 1‚Äù.

Podemos crear ahora un nuevo alias para el endpoint de nuestra Skill en desarrollo al que llamaremos ‚ÄúAlias 2‚Äù y vincularlo a la versi√≥n $LATEST, la cual s√≠ podremos modificar tranquilamente para testear cambios en nuestra Skill sin estropear nuestra Skill en producci√≥n.

![Alexa Skill Lambda Alias](https://s3-eu-west-1.amazonaws.com/blog-cjr-assets/lambdaalias2.png)

Una vez que la nueva versi√≥n es estable con los nuevos cambios a√±adidos, podemos publicar una versi√≥n ‚ÄúVersi√≥n 2‚Äù y cambiar la versi√≥n a la que apunta el ‚ÄúAlias 1‚Äù, endpoint de nuestra Skill p√∫blica. Habremos actualizado nuestra Skill en producci√≥n sin necesidad de pasar un proceso de certificaci√≥n.

En caso de realizar cambios a su vez en el Modelo de Interacci√≥n Vocal, s√≠ deberemos pasar por el proceso de certificaci√≥n y, por tanto, el endpoint de nuestra Skill publicada cambiar√° cuando la Skill que estaba en desarrollo sea aceptada, pasando a apuntar a la versi√≥n $LATEST del alias ‚ÄúAlias 2‚Äù. Una vez pasado el proceso de certificaci√≥n y publicada nuestra Skill con este nuevo endpoint apuntando al ARN del alias ‚ÄúAlias 2‚Äù con la versi√≥n $LATEST, podemos publicar exitosamente una versi√≥n estable con nombre ‚ÄúVersi√≥n 2‚Äù y dejar este alias est√°tico vincul√°ndolo a esta versi√≥n. El ‚ÄúAlias 1‚Äù lo apuntaremos ahora hacia la versi√≥n $LATEST, siendo as√≠ esta versi√≥n la que editemos siempre en desarrollo y, ahora, el ‚ÄúAlias 1‚Äù ser√° el que representar√° el endpoint de nuestra Skill en desarrollo y el ‚ÄúAlias 2‚Äù nuestra Skill en producci√≥n.

![Alexa Skill Lambda Alias](https://s3-eu-west-1.amazonaws.com/blog-cjr-assets/lambdaalias3.png)

Tambi√©n podr√≠amos optar por generar un nuevo alias por cada versi√≥n que publiquemos. Sin embargo, tan s√≥lo con dos alias y, aplicando un intercambio adecuado de versiones, podemos ser perfectamente capaces de tener nuestros dos entornos de desarrollo y producci√≥n.

Manejo de datos persistentes con AWS
------------------------------------

En una Alexa-Hosted Skill, si quer√≠amos trabajar con datos persistentes deb√≠amos hacer uso de Amazon S3. Sin embargo, con nuestra propia funci√≥n Lambda podemos recurrir a DynamoDB. Para ello, debemos completar la creaci√≥n de nuestra funci√≥n Lambda con la edici√≥n de las pol√≠ticas del rol que esta tiene o la creaci√≥n de nuevas pol√≠ticas que le permitan el acceso a DynamoDB.

En la secci√≥n de Permisos de nuestra funci√≥n Lambda podemos abrir el rol que tiene asignado nuestra funci√≥n, y editar las pol√≠ticas que tiene asociadas, a√±adiendo a estas los permisos necesarios para la lectura y escritura de datos persistentes almacenados en DynamoDB.

![Alexa Skill Lambda DynamoDB](https://s3-eu-west-1.amazonaws.com/blog-cjr-assets/lambda6.png)

Podemos a√±adir, por ejemplo, las siguientes acciones a la pol√≠tica de nuestro rol de ejecuci√≥n:

```json
{
  "Effect": "Allow",
    "Action": [
      "dynamodb:CreateTable",
      "dynamodb:PutItem",
      "dynamodb:GetItem",
      "dynamodb:UpdateItem",
      "dynamodb:PutItem",
      "dynamodb:DeleteItem",
      "dynamodb:Scan",
      "dynamodb:Query",
      "dynamodb:BatchGetItem",
      "dynamodb:BatchWriteItem"
    ],
    "Resource": "arn:aws:dynamodb:*:*:table/[TABLE_NAME]"
}
```

La tabla cuyo nombre debemos insertar en \[TABLE\_NAME\] deberemos crearla manualmente en AWS en DynamoDB o bien program√°ticamente mediante c√≥digo en nuestra funci√≥n Lambda.

En la capa gratuita de DynamoDB tendremos los siguientes servicios:

25 GB de almacenamiento de datos.

1 GB/mes de transferencia saliente de datos (15 GB/mes en los primeros 12 meses), acumulado para los servicios de AWS.

25 WCU y 25 RCU de capacidad aprovisionada.

25 rWCU para tablas globales implementadas en dos regiones de AWS.

2.5 millones de solicitudes de lectura de stream de DynamoDB Streams.

> ‚ÄúI like crossing the imaginary boundaries people set up between different fields ‚Äî it‚Äôs very refreshing. There are lots of tools, and you don‚Äôt know which one would work. It‚Äôs about being optimistic and trying to connect things.‚Äù
>
> ###### Maryam Mirzakhani